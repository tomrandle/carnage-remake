<!DOCTYPE html>
<html>
<head>
    <title>Carnage remake</title>

    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.min.js"></script>

    <script src="keyStatus.js"></script>
    <script src="jquery.hotkeys.js"></script>

    <script>

        $(document).ready(function() {


            /* Variables */

            var FPS = 30;
            var g = 10;
            var timeInterval = 1 / FPS;

            /* Create canvas */

            var canvasWidth = $(window).width();
            var canvasHeight = $(window).height();

            var canvasElement = $("<canvas width='" + canvasWidth + "' height='" + canvasHeight + "'></canvas>");
            var canvas = canvasElement.get(0).getContext("2d");

            canvasElement.appendTo('body');


            /* Create players */ 



            /* Each frame */
    
            function update() {
                

   

                /* Crash */ 

                /* Forward motion */

                player.calculatePositions();


                /* Keyboard inputs */

                if (keydown.left) {
                    player.angleOfAttack += player.turnSpeed;
                }

                if (keydown.right) {
                    player.angleOfAttack -= player.turnSpeed;

                }

                if (keydown.space) {
                    console.log('fire');
                }


                if (player.angleOfAttack >= (Math.PI))
                {
                    player.angleOfAttack = player.angleOfAttack - (Math.PI * 2);
                }

                else {
                    if (player.angleOfAttack <= - Math.PI)
                    {
                        player.angleOfAttack = player.angleOfAttack + (2 * Math.PI);
                    }
                }
            }

    
            function draw() {
                canvas.clearRect(0, 0, canvasWidth, canvasHeight);
                player.draw();
                player.drawForceVectors();
            }
            
            
            setInterval(function() {
                update();
                draw();
            }, 1000/FPS);


            var bullet = {
                speed: 100, //needs to be about twice the maximum speed of the plane?
                x: 0,
                y: 0,
                sourceX: 0, 
                sourceY: 0,
                angle: 0, 
                position: 0,
                owner: 0, 

                updateReadings: function() {
                    console.log('update bullet readings');
                },

                draw: function() {
                     console.log('draw bullet');
                },
            };

            var player = {
                color: "#00A",
                rotateAnticlockwiseKey: 'left',
                rotateClockwiseKey:'right',
                shootKey:'space',
                bullets: 2,
                kills: 0,
                lives: 10,
                takeOffPosition:1,
                x: 220,
                y: 270,
                angleOfAttack: 0,
                turnSpeed: Math.PI / 32,
                xSpeed:0,
                ySpeed:0,
                width:40,
                height:20,
                mass:100,
                weight: 0,
                terminalVelocity:50,
                dragCoefficient: 0.1,
                thrust: 600,

                fire: function() {
                    console.log('player fired');
                },

                calculateLift: function() {
                    
                    // var angle = this.calculateAngleOfMotion();

                    // var liftCoefficient = 0.1;


                    // if (Math.abs(angle) > Math.PI /2 ) {
                    //     liftCoefficient = 0;
                    // }

                   
                    // var lift = liftCoefficient * this.airspeed() * this.airspeed();
                    return (0);

                },

                calculateDrag: function() {

                    // To be realisitc the drag and lift coefficients need to change depending on the direction the plane is pointing. Drag needs to be much more agressive in the direction perpendicular to the bearing of the plane. 

                    var drag = this.dragCoefficient * this.airspeed() * this.airspeed();
                    return(drag);
                },

                calculateXAcceleration: function(){
                    // ((F-D)cosC + L sin C ) / m;

                    var thrustComponent = this.thrust *  Math.cos(this.angleOfAttack);
                    var dragComponent = this.calculateDrag() * Math.cos(this.calculateAngleOfMotion());
                    var liftComponent =this.calculateLift() * Math.sin(this.calculateAngleOfMotion());

                    $('#thrust-x-value').html(thrustComponent);
                    $('#drag-x-value').html(dragComponent);
                    $('#lift-x-value').html(liftComponent);


                    var a = (thrustComponent - dragComponent + liftComponent) / this.mass;
                    return(a);
                },

                calculateYAcceleration: function(){
                    // ((F-D)sinC + L cos C - W) / m;

                    var thrustComponent = this.thrust *  Math.sin(this.angleOfAttack);
                    var dragComponent = this.calculateDrag() * Math.sin(this.calculateAngleOfMotion());
                    var liftComponent = this.calculateLift() * Math.cos(this.calculateAngleOfMotion());


                    $('#thrust-y-value').html(thrustComponent);
                    $('#drag-y-value').html(dragComponent);
                    $('#lift-y-value').html(liftComponent);
                    var a = (thrustComponent - dragComponent + liftComponent - this.weight) /this.mass;
                    return(a);

                    
           
                },


                calculateSpeeds: function () {
                    var aX = this.calculateXAcceleration();
                    var aY = this.calculateYAcceleration();

                    /* v = u + at */

                    this.xSpeed = this.xSpeed + (aX * timeInterval);
                    this.ySpeed = this.ySpeed + (aY * timeInterval);

                },

                calculatePositions: function() {
                        
                    this.calculateSpeeds();

                    /* Infinite canvas */

                    if (this.x > canvasWidth) {
                        this.x = 0;
                    }

                    if (this.x < 0) {
                        this.x = canvasWidth;
                    }


                    if (this.y > canvasHeight) {
                        this.y = 0;
                    }

                    if (this.y < 0) {
                        this.y = canvasHeight;
                    }

                    /* s = ut + 0.5 at^2*/
                    /*BODGE*/

                    this.x = this.x + (this.xSpeed * timeInterval);
                    this.y = this.y + (this.ySpeed * timeInterval);

                    },


       

                airspeed: function() {
                    var v = (Math.sqrt(Math.pow(this.xSpeed,2) + Math.pow(this.ySpeed,2)));
                    return(v);
                },

                calculateAngleOfMotion: function() {

                    var angle = Math.atan(this.ySpeed / this.xSpeed);
                        if (!angle) {
                        return(0);
                    }

                    if (this.xSpeed < 0 && this.ySpeed > 0)
                    {
                        angle = angle + Math.PI;

                    }

                    if (this.xSpeed < 0 && this.ySpeed < 0)
                    {
                        angle = angle - Math.PI;
                    }    
                
                    return (angle);

                },

                updateReadings: function() {
                    $('#bearing-value').html(this.angleOfAttack * 180 / Math.PI);
                    $('#angle-of-motion-value').html(this.calculateAngleOfMotion() * 180 / Math.PI);

                    $('#acceleration-x-value').html(this.calculateXAcceleration());
                    $('#acceleration-y-value').html(this.calculateYAcceleration());
                    $('#speed-x-value').html(this.xSpeed);
                    $('#speed-y-value').html(this.ySpeed);
                    $('#x-value').html(this.x);
                    $('#y-value').html(this.y);
                    $('#airspeed-value').html(this.airspeed());
                    $('#drag-value').html(this.calculateDrag());

                },
                draw: function() {
                    this.updateReadings();
                    canvas.save();
                    canvas.translate(this.x, (canvasHeight - this.y));
                    canvas.translate(this.width, this.height);
                    canvas.rotate(-this.angleOfAttack);
                    canvas.fillStyle = this.color;
                    canvas.fillRect((- this.width / 2), (- this.height / 2), this.width, this.height);
                    canvas.restore();
                },

                drawForceVectors: function() {

                    var lineScale = 1;
                    var currentX = this.x + this.width;
                    var currentY = canvasHeight - this.y + this.height;


                    /* Weight */

                    var weightLineEndX = (this.weight * lineScale) + currentY;

                    canvas.beginPath();
                    canvas.moveTo(currentX, currentY);
                    canvas.lineTo(currentX,weightLineEndX);
                    canvas.stroke();

                    /* Lift */
                    
                    var liftLineEndX = (Math.sin(-this.angleOfAttack) * this.calculateLift() * lineScale) + currentX;
                    var liftLineEndY = -(Math.cos(-this.angleOfAttack) * this.calculateLift() * lineScale) + currentY;

                    canvas.beginPath();
                    canvas.moveTo(currentX, currentY);
                    canvas.lineTo(liftLineEndX,liftLineEndY);
                    canvas.stroke();

                    /* Thrust */
                    
                    var thrustLineEndX = (Math.cos(this.angleOfAttack) * this.thrust * lineScale) + currentX;
                    var thrustLineEndY = (Math.sin(-this.angleOfAttack) * this.thrust * lineScale) + currentY;

                    canvas.beginPath();
                    canvas.moveTo(currentX, currentY);
                    canvas.lineTo(thrustLineEndX,thrustLineEndY);
                    canvas.stroke();

                    /* Drag */

                    var drag = this.calculateDrag();
                    
                    var dragLineEndX = -(Math.cos(this.calculateAngleOfMotion()) * drag * lineScale) + currentX;
                    var dragLineEndY = (Math.sin(this.calculateAngleOfMotion()) * drag * lineScale) + currentY;


                    canvas.beginPath();
                    canvas.moveTo(currentX, currentY);
                    canvas.lineTo(dragLineEndX,dragLineEndY);
                    canvas.stroke();

                }
            };
        });

    </script>

    <style type="text/css">
        body {margin: 0; font-family:arial; font-size:11px;}
        canvas {background: lightblue;}
        table {position: fixed; right:10px; top:10px; width: 200px;}
    </style>

</head>

<body>
    <table id="data">
        <tr><td>Bearing</td><td id="bearing-value"></td></tr>
        <tr><td>Angle of motion</td><td id="angle-of-motion-value"></td></tr>

        <tr><td>X</td><td id="x-value"></td></tr>
        <tr><td>Y</td><td id="y-value"></td></tr>
        <tr><td>aX</td><td id="acceleration-x-value"></td></tr>
        <tr><td>aY</td><td id="acceleration-y-value"></td></tr>
        <tr><td>vX</td><td id="speed-x-value"></td></tr>
        <tr><td>vY</td><td id="speed-y-value"></td></tr>

        <tr><td>ThrustX</td><td id="thrust-x-value"></td></tr>
        <tr><td>ThrustY</td><td id="thrust-y-value"></td></tr>
        <tr><td>LiftX</td><td id="lift-x-value"></td></tr>
        <tr><td>LiftY</td><td id="lift-y-value"></td></tr>
        <tr><td>DragX</td><td id="drag-x-value"></td></tr>
        <tr><td>DragY</td><td id="drag-y-value"></td></tr>

        <tr><td>Speed</td><td id="airspeed-value"></td></tr>
        <tr><td>Drag</td><td id="drag-value"></td></tr>


    </table>
</body>

</html>